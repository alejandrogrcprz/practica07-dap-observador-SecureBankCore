<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureBank Ultimate v37 - Cashback Fixed</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* =========================================
           1. VARIABLES Y TEMA
           ========================================= */
        :root {
            --bg: #0f172a; --panel: #1e293b; --input-bg: #334155; --border: #475569;
            --accent: #3b82f6; --green: #22c55e; --red: #ef4444; --text: #f1f5f9;
            --text-muted: #94a3b8; --shadow: rgba(0,0,0,0.5);
            --gold-gradient: linear-gradient(135deg, #fcd34d 0%, #d97706 100%);
            --gold-solid: #fbbf24;
            --corp-gradient: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            --corp-header-bg: #1e293b; --corp-footer-bg: #0f172a;
            --prem-header-bg: linear-gradient(90deg, #050505 0%, #1a1a1a 100%); --prem-footer-bg: #000000;
        }

        body.light-mode {
            --bg: #f8fafc; --panel: #ffffff; --input-bg: #e2e8f0; --border: #cbd5e1;
            --accent: #2563eb; --text: #0f172a; --text-muted: #64748b; --shadow: rgba(0,0,0,0.1);
        }

        body {
            background: var(--bg); color: var(--text);
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            margin: 0; min-height: 100vh; display: flex; flex-direction: column;
            transition: background 0.3s, color 0.3s;
        }

        /* LOADER */
        #loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.85); z-index: 9999; display: none;
            justify-content: center; align-items: center; flex-direction: column;
            backdrop-filter: blur(5px);
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { font-weight: bold; letter-spacing: 1px; animation: pulse 1.5s infinite; color: var(--text); }

        /* HEADER */
        .app-header {
            background: var(--corp-header-bg); padding: 15px 40px; display: none;
            justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.5s ease; position: relative; z-index: 100;
        }
        .app-logo-container { display: flex; align-items: center; gap: 15px; }
        .app-logo { font-size: 1.6rem; font-weight: 800; display: flex; align-items: center; gap: 10px; color: var(--text); letter-spacing: 0.5px; }
        .header-badge { font-size: 0.75rem; padding: 6px 16px; border-radius: 20px; font-weight: 800; cursor: pointer; letter-spacing: 0.5px; transition: all 0.3s ease; text-transform: uppercase; display: inline-block; }
        .header-badge.plan-free { background: rgba(255, 255, 255, 0.1); color: var(--text-muted); border: 1px solid var(--border); }
        .header-badge.plan-free:hover { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        .header-badge.plan-premium { background: var(--gold-gradient); color: #000; border: none; box-shadow: 0 0 15px rgba(251, 191, 36, 0.4); animation: pulse-gold 2s infinite; }
        .header-badge.plan-premium:hover { transform: scale(1.05); }
        @keyframes pulse-gold { 0% { box-shadow: 0 0 10px rgba(251, 191, 36, 0.4); } 50% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.7); } 100% { box-shadow: 0 0 10px rgba(251, 191, 36, 0.4); } }
        .app-header.premium-mode { background: var(--prem-header-bg); border-bottom: 1px solid #b45309; }
        .app-header.premium-mode .app-logo { color: var(--gold-solid) !important; text-shadow: 0 0 15px rgba(251, 191, 36, 0.4); }

        /* FOOTER */
        .app-footer { background: var(--corp-footer-bg); padding: 20px 40px; display: none; text-align: center; font-size: 0.85rem; color: var(--text-muted); border-top: 1px solid var(--border); margin-top: auto; transition: all 0.5s ease; }
        .app-footer.premium-mode { background: var(--prem-footer-bg); border-top: 1px solid #b45309; color: #d97706; }

        /* LAYOUT */
        #auth-view { display: flex; flex: 1; align-items: center; justify-content: center; width: 100%; height: 100vh; }
        .box { background: var(--panel); padding: 40px; border-radius: 16px; width: 340px; text-align: center; box-shadow: 0 20px 50px var(--shadow); border: 1px solid var(--border); }
        .auth-tabs { display: flex; margin-bottom: 25px; border-bottom: 1px solid var(--border); }
        .auth-tab { flex: 1; padding: 12px; cursor: pointer; color: var(--text-muted); font-weight: 500; transition: 0.3s; }
        .auth-tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); font-weight: bold; }

        input, select { width: 100%; padding: 14px; background: var(--input-bg); border: 1px solid var(--border); color: var(--text); border-radius: 8px; margin: 8px 0; box-sizing: border-box; transition: 0.3s; outline: none; }
        input:focus { border-color: var(--accent); }
        button { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 15px; transition: 0.2s; font-size: 1rem;}
        button:hover { opacity: 0.9; transform: translateY(-1px); }

        #dashboard-view { display: none; width: 100%; max-width: 1200px; padding: 20px; margin: 0 auto; box-sizing: border-box; flex: 1; }
        .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }

        .dash-nav { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .nav-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; padding: 25px 15px; background: var(--panel); color: var(--text-muted); border: 1px solid var(--border); border-radius: 16px; cursor: pointer; transition: all 0.3s; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.05); height: 100%; }
        .nav-btn .nav-icon { font-size: 2rem; filter: grayscale(1); transition: 0.3s; }
        .nav-btn:hover { transform: translateY(-5px); border-color: var(--accent); box-shadow: 0 10px 20px rgba(0,0,0,0.2); color: var(--text); }
        .nav-btn:hover .nav-icon { filter: grayscale(0); transform: scale(1.1); }
        .nav-btn.active { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4); transform: translateY(0); }
        .nav-btn.active .nav-icon { filter: grayscale(0) brightness(200%); }
        @media (max-width: 700px) { .dash-nav { grid-template-columns: repeat(2, 1fr); gap: 10px; } .nav-btn { padding: 15px; } }

        .tab-content { display: none; animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); } .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .home-grid { display: grid; grid-template-columns: 1fr 1.4fr; gap: 25px; align-items: start; }
        .left-column, .right-column { display: flex; flex-direction: column; gap: 25px; }
        .hub-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .analysis-grid { display: grid; grid-template-columns: 1fr; gap: 25px; }
        .cards-view { display: flex; flex-direction: column; align-items: center; max-width: 600px; margin: 0 auto; }

        .card { background: var(--panel); padding: 25px; border-radius: 16px; box-shadow: 0 10px 15px -3px var(--shadow); border: 1px solid var(--border); }
        .acc-item { background: var(--bg); padding: 15px; margin-bottom: 12px; border-radius: 10px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; transition: transform 0.2s; }
        .acc-item:hover { transform: translateX(5px); border-color: var(--accent); }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.95em; }
        th { text-align: left; color: var(--text-muted); padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: 15px 12px; border-bottom: 1px solid var(--border); color: var(--text); }
        .amount-pos { color: var(--green); font-weight: bold; } .amount-neg { color: var(--red); font-weight: bold; }

        .header-actions { display: flex; align-items: center; gap: 12px; }
        .icon-btn { background: var(--input-bg); border: 1px solid var(--border); color: var(--text); font-size: 1.2rem; padding: 10px; border-radius: 12px; width: 45px; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; position: relative; margin-top: 0;}
        .icon-btn:hover { background: var(--border); transform: scale(1.05); }
        .notif-badge { position: absolute; top: -5px; right: -5px; background-color: var(--red); color: white; font-size: 0.7rem; font-weight: bold; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid var(--bg); }

        .apy-tag { background: var(--input-bg); color: var(--text-muted); font-size: 0.75rem; padding: 4px 8px; border-radius: 6px; margin-left: 10px; vertical-align: middle; border: 1px solid var(--border); }
        .apy-tag.premium { background: rgba(34, 197, 94, 0.15); color: var(--green); border: 1px solid var(--green); font-weight: bold; }

        .coin-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .coin-btn { background: var(--input-bg); border: 1px solid var(--border); flex: 1; padding: 12px; text-align: center; cursor: pointer; border-radius: 8px; color: var(--text); font-weight: 600; }
        .coin-btn.active { background: var(--accent); border-color: var(--accent); color: white; }
        .crypto-chart-container { position: relative; height: 300px; width: 100%; margin-bottom: 20px; }

        .hucha-container { text-align: center; margin-bottom: 20px; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 12px; }
        .progress-track { width: 100%; background: var(--input-bg); height: 12px; border-radius: 10px; overflow: hidden; margin: 15px 0; }
        .progress-fill { height: 100%; background: var(--green); width: 0%; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }

        .converter-grid { display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; align-items: center; margin-top: 15px; margin-bottom: 15px; }
        .equals { text-align: center; font-size: 1.5rem; font-weight: bold; color: var(--accent); }

        /* Sliders */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 15px 0; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: var(--accent); cursor: pointer; margin-top: -8px; box-shadow: 0 0 10px rgba(0,0,0,0.5); transition: 0.2s; }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: var(--border); border-radius: 2px; }

        .switch { position: relative; display: inline-block; width: 46px; height: 24px; vertical-align: middle; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--input-bg); transition: .4s; border-radius: 34px; border: 1px solid var(--border); }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--green); border-color: var(--green); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* Tarjeta 3D */
        .card-scene { perspective: 1000px; width: 320px; height: 200px; margin: 0 auto 25px auto; cursor: pointer; }
        .card-object { width: 100%; height: 100%; position: relative; transition: transform 0.8s; transform-style: preserve-3d; border-radius: 16px; box-shadow: 0 15px 35px rgba(0,0,0,0.4); }
        .card-object.flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 16px; padding: 25px; box-sizing: border-box; background: linear-gradient(135deg, #4f46e5, #9333ea); color: white; display: flex; flex-direction: column; justify-content: space-between; border: 1px solid rgba(255,255,255,0.1); }
        .card-face.back { transform: rotateY(180deg); background: linear-gradient(135deg, #4338ca, #7e22ce); }
        .frozen .card-object { filter: grayscale(100%) opacity(0.7); }
        .card-object.gold .card-face { background: linear-gradient(135deg, #d97706, #fbbf24, #b45309); color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.3); border: 1px solid #fcd34d; }
        .card-object.gold .card-face.back { background: linear-gradient(135deg, #b45309, #d97706); }
        .card-object.gold .card-chip { background: linear-gradient(45deg, #f3f4f6, #9ca3af); }
        .card-brand-name { position: absolute; top: 25px; right: 25px; font-weight: 800; letter-spacing: 2px; font-size: 1.1em; text-transform: uppercase; opacity: 0.9; }
        .card-chip { width: 50px; height: 38px; background: linear-gradient(45deg, #fbbf24, #d97706); border-radius: 6px; margin-top: 5px; box-shadow: inset 0 0 5px rgba(0,0,0,0.3); }
        .card-footer-row { display: flex; justify-content: space-between; align-items: flex-end; }
        .card-masked-num { font-size: 1.5em; font-family: monospace; letter-spacing: 3px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .card-logo-visa { font-weight: 900; font-style: italic; font-size: 1.8em; opacity: 0.9; }
        .card-data-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px;}
        .card-label { font-size: 0.65em; color: rgba(255,255,255,0.7); text-transform: uppercase; display: block; letter-spacing: 1px; }
        .card-value { font-family: monospace; font-size: 1.2em; letter-spacing: 1.5px; }
        .copy-icon { cursor: pointer; font-size: 1.2em; opacity: 0.7; transition: 0.2s; } .copy-icon:hover { opacity: 1; transform: scale(1.2); color: #fbbf24; }
        .card-tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; width: 320px; }
        .tool-btn { background: var(--input-bg); border: 1px solid var(--border); color: var(--text-muted); padding: 12px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9em; font-weight: 600; transition: all 0.2s ease; text-align: center; user-select: none; }
        .tool-btn:hover { background: var(--border); color: var(--text); transform: translateY(-2px); }
        .tool-btn.active-eye { background: rgba(34, 197, 94, 0.1); border-color: var(--green); color: var(--green); }
        .tool-btn.active-freeze { background: rgba(239, 68, 68, 0.1); border-color: var(--red); color: var(--red); }

        .btn-bizum { background: #f97316; color: white; font-weight: bold; width: auto; padding: 6px 15px; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9em; border-radius: 6px; }
        .btn-bizum:hover { background: #ea580c; }

        .btn-ingreso { background: #22c55e; color: white; font-weight: bold; width: auto; padding: 6px 15px; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9em; border-radius: 6px; margin-left: 10px; }
        .btn-ingreso:hover { background: #16a34a; }

        .msg-list { max-height: 400px; overflow-y: auto; text-align: left; }
        .msg-item { padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; transition: 0.2s; border-left: 3px solid transparent; }
        .msg-item:hover { background: rgba(128,128,128,0.05); }
        .msg-item.unread { border-left: 3px solid var(--accent); background: rgba(59, 130, 246, 0.05); }
        .msg-title { font-weight: bold; display: block; margin-bottom: 5px; color: var(--text); }
        .msg-body { font-size: 0.9rem; color: var(--text-muted); display: none; margin-top: 10px; line-height: 1.5; }
        .msg-item.expanded .msg-body { display: block; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background: var(--panel); padding: 30px; border-radius: 16px; width: 350px; text-align: center; border: 1px solid var(--border); position: relative; color: var(--text); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7); animation: slideUp 0.3s ease; }
        .modal-content.wide { width: 600px; max-width: 95%; }
        .close-modal { position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 1.5rem; color: var(--text-muted); transition: 0.2s; z-index: 10; }
        .close-modal:hover { color: var(--red); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .premium-hero { background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(217, 119, 6, 0.1) 100%); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 25px; }
        .premium-title { background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.8rem; font-weight: 800; margin: 0 0 5px 0; text-transform: uppercase; letter-spacing: 1px; }
        .premium-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; text-align: left; }
        .feat-card { background: rgba(0,0,0,0.2); border: 1px solid var(--border); padding: 15px; border-radius: 10px; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .feat-card:hover { border-color: #fbbf24; transform: translateY(-2px); background: rgba(251, 191, 36, 0.05); }
        .feat-icon { font-size: 1.5rem; min-width: 30px; text-align: center; }
        .feat-text { font-size: 0.9rem; font-weight: 600; color: var(--text); }
        .feat-text small { display: block; color: var(--text-muted); font-weight: 400; font-size: 0.8em; }
        .premium-price { font-size: 2.5rem; font-weight: bold; color: #fbbf24; margin: 10px 0; text-shadow: 0 0 20px rgba(251, 191, 36, 0.3); }
        .btn-upgrade { background: var(--gold-gradient); color: #fff; border: none; font-size: 1.1rem; padding: 16px; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 10px 20px -5px rgba(217, 119, 6, 0.5); }
        .btn-upgrade:hover { box-shadow: 0 15px 30px -5px rgba(217, 119, 6, 0.7); transform: translateY(-2px); }

        /* PERFIL COMPACTO & CORPORATIVO */
        .modal-content.profile-full-modal {
            width: 700px; max-width: 95%; padding: 0;
            border: 1px solid var(--border); background: var(--panel); color: var(--text);
            overflow: hidden; text-align: left;
        }
        .bank-header {
            background-color: var(--input-bg); color: var(--text); padding: 15px 25px;
            display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border);
        }
        .bank-header h2 { margin: 0; font-size: 1.2rem; font-weight: 700; letter-spacing: 1px; }
        .bank-footer {
            background-color: var(--input-bg); color: var(--text-muted); padding: 15px 25px;
            display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; border-top: 1px solid var(--border);
        }
        .bank-footer-logo { font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; color: var(--text); }
        .bank-footer-text { text-align: right; opacity: 0.7; }
        .profile-body { padding: 25px; background: var(--panel); margin: 0; }
        .profile-section-title {
            font-size: 1.1rem; color: var(--accent); border-bottom: 1px solid var(--border);
            padding-bottom: 10px; margin-bottom: 20px;
        }
        .profile-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .p-group { display: flex; flex-direction: column; }
        .p-group.full { grid-column: span 2; }
        .p-label { font-weight: 600; margin-bottom: 5px; color: var(--text-muted); font-size: 0.85rem; }
        .profile-body input {
            background: var(--input-bg) !important; border: 1px solid var(--border) !important;
            color: var(--text) !important; padding: 10px; border-radius: 6px;
        }
        .profile-body input:focus { border-color: var(--accent) !important; }
        .profile-actions { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; }
        .btn-p-save { background: var(--green); color: white; width: auto; padding: 10px 20px; }
        .btn-p-cancel { background: var(--red); color: white; width: auto; padding: 10px 20px; }

        /* MODAL DE BIENVENIDA (CORPORATIVO) */
        .welcome-hero { background: var(--corp-gradient); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center; }
        .welcome-title { font-size: 1.5rem; font-weight: 800; margin: 0 0 10px 0; color: white; }
        .welcome-text { font-size: 0.95rem; color: rgba(255,255,255,0.8); line-height: 1.5; }
        .welcome-btn { background: white; color: var(--bg); border: none; font-weight: bold; width: 100%; padding: 14px; border-radius: 8px; margin-top: 15px; transition: 0.2s; font-size: 1rem; }
        .welcome-btn:hover { background: #f1f5f9; transform: translateY(-2px); }

        @media (max-width: 600px) {
            .profile-grid { grid-template-columns: 1fr; }
            .p-group.full { grid-column: span 1; }
            .bank-footer { flex-direction: column; gap: 10px; text-align: center; }
            .app-header { padding: 10px 20px; }
            .app-footer { padding: 20px; flex-direction: column; gap: 10px; }
        }

        @media (max-width: 900px) { .home-grid, .hub-grid, .analysis-grid, .premium-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div id="loader-overlay">
    <div class="spinner"></div>
    <div id="loader-text" class="loading-text">Cargando...</div>
</div>

<header id="global-header" class="app-header">
    <div class="app-logo-container">
        <div class="app-logo">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 1L3 5V11C3 16.55 6.84 21.74 12 23C17.16 21.74 21 16.55 21 11V5L12 1ZM12 11.99H7V10H17V11.99H12Z"/>
            </svg>
            SecureBank Ultimate
        </div>
        <div id="header-plan-badge" class="header-badge plan-free" onclick="openPremiumModal()">
            Hazte PREMIUM
        </div>
    </div>
    <div style="font-size: 0.9em; opacity: 0.8;">Banca Online Segura</div>
</header>

<div id="auth-view">
    <div class="box">
        <h2 style="margin-bottom:20px;">üîê SecureBank <span style="color:var(--accent)">Ultimate</span></h2>
        <div class="auth-tabs">
            <div class="auth-tab active" onclick="showAuthTab('login')">Entrar</div>
            <div class="auth-tab" onclick="showAuthTab('reg')">Registro</div>
        </div>
        <div id="login-form" autocomplete="off">
            <input type="text" id="l-dni" placeholder="DNI (Usuario)" autocomplete="off">
            <input type="password" id="l-pass" placeholder="Contrase√±a" autocomplete="new-password">
            <button onclick="login()">INICIAR SESI√ìN</button>
        </div>
        <div id="reg-form" style="display:none;" autocomplete="off">
            <input type="text" id="r-dni" placeholder="DNI" autocomplete="off">
            <input type="text" id="r-name" placeholder="Nombre" autocomplete="off">
            <input type="text" id="r-last" placeholder="Apellidos" autocomplete="off">
            <input type="password" id="r-pass" placeholder="Contrase√±a" autocomplete="new-password">
            <button onclick="register()">CREAR CUENTA</button>
        </div>
    </div>
</div>

<div id="dashboard-view">
    <div class="dash-header">
        <div style="display: flex; align-items: center;">
            <h1 style="margin:0; font-size:1.8rem;">Hola, <span id="user-display" style="color:var(--accent)">User</span> üëã</h1>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="toggleTheme()" title="Tema"><span id="theme-icon">üåô</span></button>
            <button class="icon-btn" onclick="openProfile()" title="Perfil">‚öôÔ∏è</button>
            <button class="icon-btn" onclick="openMailbox()">üîî<span id="notif-badge" class="notif-badge" style="display:none;">0</span></button>
            <button class="icon-btn" onclick="logout()" title="Cerrar Sesi√≥n">üö™</button>
        </div>
    </div>

    <div class="dash-nav">
        <button class="nav-btn active" onclick="showDashTab('home')"><span class="nav-icon">üè†</span>Inicio</button>
        <button class="nav-btn" onclick="showDashTab('cards')"><span class="nav-icon">üí≥</span>Tarjetas</button>
        <button class="nav-btn" onclick="showDashTab('hub')"><span class="nav-icon">üöÄ</span>Hub</button>
        <button class="nav-btn" onclick="showDashTab('analytics')"><span class="nav-icon">üìä</span>An√°lisis</button>
    </div>

    <div id="tab-home" class="tab-content active">
        <div class="home-grid">
            <div class="left-column">
                <div class="card">
                    <h3>üí≥ Mis Cuentas</h3>
                    <div id="acc-list"></div>
                </div>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="margin:0;">üí∏ Operaciones</h3>
                        <div>
                            <button class="btn-bizum" onclick="openBizumModal()">‚ö° Bizum</button>
                            <button class="btn-ingreso" onclick="openDepositModal()">üì• Ingresar</button>
                        </div>
                    </div>
                    <label style="font-size:0.85em; color:var(--text-muted); margin-bottom:5px; display:block;">Cuenta Origen</label>
                    <select id="t-source"></select>

                    <label style="font-size:0.85em; color:var(--text-muted); margin-bottom:5px; display:block; margin-top:10px;">Destinatario</label>
                    <input type="text" id="t-dest" placeholder="IBAN Destino (Ej: ES21...)" onblur="checkIban()" style="text-transform: uppercase;">
                    <div id="iban-check" style="height:20px; font-size:0.8em; margin-bottom:5px;"></div>

                    <div style="display:flex; gap:15px;">
                        <div style="flex:1"><input type="number" id="t-amount" placeholder="Importe (‚Ç¨)"></div>
                        <div style="flex:1"><input type="text" id="t-concept" placeholder="Concepto"></div>
                    </div>
                    <button onclick="transfer()">ENVIAR DINERO</button>
                </div>
            </div>

            <div class="right-column">
                <div class="card">
                    <h3 style="margin-bottom:15px;">üí± Conversor R√°pido</h3>
                    <div class="converter-grid">
                        <div><input type="number" id="amount-one" value="1" oninput="calculate()"><select id="currency-one" onchange="calculate()"><option value="EUR" selected>EUR</option><option value="USD">USD</option><option value="GBP">GBP</option><option value="JPY">JPY</option><option value="BTC">BTC</option></select></div>
                        <div class="equals">‚âà</div>
                        <div><input type="number" id="amount-two" disabled><select id="currency-two" onchange="calculate()"><option value="EUR">EUR</option><option value="USD" selected>USD</option><option value="GBP">GBP</option><option value="JPY">JPY</option><option value="BTC">BTC</option></select></div>
                    </div>
                    <p style="text-align: center; margin-top: 5px; color: var(--text-muted); font-size:0.85em;">Tasa real de mercado. Actualizaci√≥n en vivo.</p>
                    <div style="text-align: right; margin-top: 5px; font-size: 0.7em; color: var(--text-muted);">Rates by <a href="https://www.exchangerate-api.com" target="_blank" style="color:var(--accent); text-decoration:none;">ExchangeRate-API</a></div>
                </div>

                <div class="card">
                    <h3>üìÑ √öltimos Movimientos</h3>
                    <table id="history-table">
                        <thead><tr><th>Concepto</th><th style="text-align:right">Importe</th><th style="text-align:center">PDF</th></tr></thead>
                        <tbody id="history-body"><tr><td colspan="3" style="text-align:center; padding:20px; color:var(--text-muted);">Cargando datos...</td></tr></tbody>
                    </table>
                    <button id="security-btn" onclick="openSecurityModal()" style="display:none; background: #334155; margin-top: 20px; font-size:0.9em;">üîí Desbloquear historial completo</button>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-cards" class="tab-content">
        <div class="cards-view">
            <div class="card" style="width: 100%; text-align:center;">
                <h3 style="margin-bottom:30px;">Gesti√≥n de Tarjeta Virtual</h3>

                <div class="card-scene" onclick="handleCardClick()">
                    <div id="virtual-card" class="card-object">
                        <div class="card-face front">
                            <div class="card-brand-name">NEON ELITE</div>
                            <div class="card-chip"></div>
                            <div></div>
                            <div class="card-footer-row">
                                <div class="card-masked-num">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 4291</div>
                                <div class="card-logo-visa">VISA</div>
                            </div>
                        </div>
                        <div class="card-face back">
                            <div class="card-data-row"><div><span class="card-label">Card Number</span><span class="card-value">4589 1234 5678 4291</span></div><span class="copy-icon" onclick="copyToClipboard('4589 1234 5678 4291', event)">üìã</span></div>
                            <div class="card-data-row"><div><span class="card-label">Expiry</span><span class="card-value">12/28</span></div><span class="copy-icon" onclick="copyToClipboard('12/28', event)">üìã</span></div>
                            <div class="card-data-row"><div><span class="card-label">CVV</span><span class="card-value">739</span></div><span class="copy-icon" onclick="copyToClipboard('739', event)">üìã</span></div>
                        </div>
                    </div>
                </div>

                <div class="card-tools-grid" style="margin: 0 auto;">
                    <div id="btn-show-card" class="tool-btn" onclick="requestCardUnlock()"><span class="tool-icon">üëÅÔ∏è</span> <span id="btn-eye-text">Ver Datos</span></div>
                    <div id="btn-freeze-card" class="tool-btn" onclick="toggleCardFreeze()"><span class="tool-icon">‚ùÑÔ∏è</span> <span id="btn-freeze-text">Congelar</span></div>
                </div>

                <div style="margin-top:30px; border-top:1px solid var(--border); padding-top:20px; text-align:left; max-width: 320px; margin-left: auto; margin-right: auto;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span style="font-size:0.9em; font-weight:600;">L√≠mite Mensual</span>
                        <strong id="limit-display" style="color:var(--accent)">2500 ‚Ç¨</strong>
                    </div>
                    <input type="range" id="limit-slider" min="500" max="10000" step="100" value="2500" oninput="updateCardLimit()">
                    <small style="color:var(--text-muted)">Controla el gasto m√°ximo permitido.</small>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-hub" class="tab-content">
        <div class="hub-grid">
            <div style="display:flex; flex-direction:column; gap:25px;">
                <div id="cashback-card" class="card" style="display:none; background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(0,0,0,0)); border: 1px solid #d97706;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="color: #fbbf24; margin:0;">üíé Rewards</h3>
                        <small style="color: #fbbf24; border:1px solid #fbbf24; padding:2px 6px; border-radius:4px; font-size:0.7em;">PREMIUM</small>
                    </div>
                    <p style="color:var(--text-muted); font-size:0.9em; margin-bottom: 5px;">Cashback acumulado</p>
                    <div style="display:flex; justify-content:space-between; align-items:end;">
                        <h2 id="cashback-display" style="color: var(--text); margin:0; font-size:2rem;">0.00 ‚Ç¨</h2>
                        <button onclick="redeemCashback()" style="width:auto; padding:5px 15px; font-size:0.8em; background:#fbbf24; color:black; border:none;">CANJEAR üí∏</button>
                    </div>
                </div>

                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;"><h3>üê∑ Mi Hucha</h3><span id="apy-badge" class="apy-tag">0% TAE</span></div>
                    <div class="hucha-container">
                        <h2 id="savings-display" style="color: var(--green); margin:0; font-size:2rem;">0.00 ‚Ç¨</h2>
                        <small style="color:var(--text-muted)">Objetivo: 1000 ‚Ç¨</small>
                        <div class="progress-track"><div class="progress-fill" id="progress-bar"></div></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; background:var(--input-bg); padding:12px; border-radius:8px; margin-bottom:20px;">
                        <span style="font-size:0.9em; font-weight:600;">üîÑ Redondeo Autom√°tico</span>
                        <label class="switch"><input type="checkbox" id="roundup-toggle" onchange="toggleRoundUp()"><span class="slider"></span></label>
                    </div>
                    <div style="display:flex; gap:10px;"><input type="number" id="hucha-input" placeholder="Cantidad..." style="margin:0;"><button onclick="addToHucha()" style="width: auto; margin:0;">A√±adir</button></div>
                    <button onclick="resetHucha()" style="background:transparent; border:1px solid var(--red); color:var(--red); margin-top:15px; font-size:0.8rem; width:100%">Romper hucha üî®</button>
                </div>

                <div class="card">
                    <h3>üí∞ Pr√©stamo R√°pido</h3>
                    <div style="margin: 20px 0;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span style="color:var(--text-muted)">Solicitar</span><strong id="loan-amount-display" style="font-size:1.2em;">2000 ‚Ç¨</strong></div>
                        <input type="range" id="loan-slider" min="500" max="10000" step="500" value="2000" oninput="updateLoanCalc()">
                        <div style="display:flex; justify-content:space-between; font-size:0.9em; margin-top:10px;"><span>Plazo: 24 meses</span><span style="background:var(--input-bg); padding:2px 6px; border-radius:4px;">TIN: <span id="loan-interest">8%</span></span></div>
                    </div>
                    <div style="background:var(--input-bg); padding:15px; border-radius:10px; text-align:center; margin-bottom:15px; border:1px solid var(--border);"><small style="color:var(--text-muted); text-transform:uppercase; letter-spacing:1px;">Cuota estimada</small><br><strong style="font-size:1.5em; color:var(--text);" id="loan-monthly">90.45 ‚Ç¨</strong></div>
                    <button onclick="requestLoan()" style="margin-top:0;">SOLICITAR AHORA</button>
                </div>
            </div>

            <div style="display:flex; flex-direction:column; gap:25px;">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;"><h3>üöÄ Crypto Market</h3><h2 style="color:var(--green); margin:0;" id="live-price">...</h2></div>
                    <div class="coin-selector" style="margin-top:15px;"><div id="btn-bitcoin" class="coin-btn active" onclick="setCoin('bitcoin')">BTC</div><div id="btn-ethereum" class="coin-btn" onclick="setCoin('ethereum')">ETH</div><div id="btn-solana" class="coin-btn" onclick="setCoin('solana')">SOL</div></div>
                    <div class="crypto-chart-container"><canvas id="cryptoChart"></canvas></div>
                    <div style="display: flex; gap: 10px; margin-top: 15px; align-items: center;"><input type="number" id="trade-eur" placeholder="‚Ç¨ Cantidad" style="flex:1; margin:0;"><button style="background:var(--green); width:auto; margin:0;" onclick="trade('BUY')">COMPRAR</button><button style="background:var(--red); width:auto; margin:0;" onclick="trade('SELL')">VENDER</button></div>
                    <small id="premium-msg" style="display:none; color: #fbbf24; text-align: center; margin-top:10px; font-weight:bold;">üåü Usuario Premium: 0% Comisiones</small>
                    <div style="text-align: right; margin-top: 10px; font-size: 0.7em; color: var(--text-muted);">Data: <a href="https://www.binance.com" target="_blank" style="color:var(--accent); text-decoration:none;">Binance API</a></div>

                    <div style="margin-top: 25px; border-top: 1px solid var(--border); padding-top: 15px;">
                        <h4 style="margin: 0 0 15px 0;">üíº Mi Portfolio</h4>
                        <div id="portfolio-list" style="font-size:0.95em;">Cargando...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-analytics" class="tab-content">
        <div class="analysis-grid">
            <div class="card">
                <div style="display:flex; justify-content: space-between; align-items: center;"><h3>üìÖ Evoluci√≥n de Gastos</h3><select id="yearSelector" onchange="yearChanged()" style="width: auto; padding: 8px;"><option value="2025">2025</option><option value="2026" selected>2026</option></select></div>
                <div style="height: 400px;"><canvas id="monthlyChart"></canvas></div>
            </div>
            <div class="card"><h3>üìä Distribuci√≥n de Gastos</h3><div style="height: 350px;"><canvas id="expensesChart"></canvas></div></div>
        </div>
    </div>
</div>

<footer id="global-footer" class="app-footer">
    <div>&copy; 2026 SecureBank Ultimate S.A. Todos los derechos reservados.</div>
    <div style="margin-top: 5px; opacity: 0.7;">
        <span style="margin: 0 10px;">Privacidad</span> |
        <span style="margin: 0 10px;">T√©rminos</span> |
        <span style="margin: 0 10px;">Ayuda</span>
    </div>
</footer>

<div id="security-modal" class="modal-overlay"><div class="modal-content"><h3>üîí Seguridad</h3><p style="color:var(--text-muted); font-size:0.9em;">Confirma contrase√±a para continuar.</p><input type="password" id="sec-pass" placeholder="Tu contrase√±a..."><div id="sec-error" style="color:var(--red); margin-top:5px; font-size:0.85em;"></div><div style="display:flex; gap:10px; margin-top:20px;"><button onclick="closeSecurityModal()" style="background:var(--input-bg); color: var(--text);">Cancelar</button><button onclick="confirmUnlock()" style="background:var(--accent)">Confirmar</button></div></div></div>

<div id="card-privacy-modal" class="modal-overlay"><div class="modal-content"><h3>üëÅÔ∏è Mostrar Datos</h3><p style="color:var(--text-muted); font-size:0.9em;">Por seguridad, introduce tu contrase√±a.</p><input type="password" id="card-pass" placeholder="Tu contrase√±a..."><div id="card-error" style="color:var(--red); margin-top:5px; font-size:0.85em;"></div><div style="display:flex; gap:10px; margin-top:20px;"><button onclick="closeCardModal()" style="background:var(--input-bg); color: var(--text);">Cancelar</button><button onclick="confirmCardUnlock()" style="background:var(--accent)">Ver Tarjeta</button></div></div></div>

<div id="mailbox-modal" class="modal-overlay"><div class="modal-content wide"><span class="close-modal" onclick="closeMailbox()">√ó</span><h3 style="text-align:left; border-bottom:1px solid var(--border); padding-bottom:15px; margin-top:0;">üì¨ Buz√≥n</h3><div id="mailbox-list" class="msg-list"></div><div style="text-align:right; margin-top:20px;"><button onclick="markAllRead()" style="width:auto; font-size:0.85em; background:var(--input-bg); color:var(--text);">Marcar todo le√≠do</button></div></div></div>

<div id="bizum-modal" class="modal-overlay"><div class="modal-content"><span class="close-modal" onclick="closeBizumModal()">√ó</span><h3 style="color: #f97316;">‚ö° Bizum R√°pido</h3><p style="color:var(--text-muted); font-size:0.9em;">Env√≠a dinero al instante solo con el m√≥vil.</p><input type="tel" id="bz-phone" placeholder="üì± M√≥vil destinatario" style="text-align:center;"><input type="number" id="bz-amount" placeholder="‚Ç¨ Importe" style="text-align:center; font-size:1.2em; font-weight:bold;"><input type="text" id="bz-concept" placeholder="üìù Concepto (Opcional)" style="text-align:center;"><div style="display:flex; gap:10px; margin-top:20px;"><button onclick="closeBizumModal()" style="background:var(--input-bg); color: var(--text);">Cancelar</button><button onclick="sendBizum()" style="background:#f97316">Enviar Ahora</button></div></div></div>

<div id="deposit-modal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-modal" onclick="closeDepositModal()">√ó</span>
        <h3 style="color: var(--green);">üì• Ingresar Dinero</h3>
        <p style="color:var(--text-muted); font-size:0.9em;">A√±ade fondos a tu cuenta.</p>
        <input type="number" id="dep-amount" placeholder="‚Ç¨ Cantidad" style="text-align:center; font-size:1.2em; font-weight:bold;">
        <select id="dep-source" style="margin-top:10px;">
            <option value="N√≥mina">üè¢ N√≥mina</option>
            <option value="Transferencia">üè¶ Transferencia</option>
            <option value="Cajero">üèß Cajero Autom√°tico</option>
            <option value="Bizum">‚ö° Bizum Recibido</option>
            <option value="Loter√≠a">üé∞ Loter√≠a</option>
        </select>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="closeDepositModal()" style="background:var(--input-bg); color: var(--text);">Cancelar</button>
            <button onclick="confirmDeposit()" style="background:var(--green)">Ingresar Ahora</button>
        </div>
    </div>
</div>

<div id="welcome-modal" class="modal-overlay" onclick="if(event.target === this) closeWelcomeModal()">
    <div class="modal-content wide">
        <span class="close-modal" onclick="closeWelcomeModal()">√ó</span>
        <div class="welcome-hero">
            <h3 class="welcome-title">Bienvenido a SecureBank Ultimate</h3>
            <p class="welcome-text">Gracias por confiar en nosotros. Tu cuenta Standard ya est√° activa y operativa.</p>
        </div>
        <div class="premium-grid">
            <div class="feat-card">
                <div class="feat-icon">üí≥</div>
                <div class="feat-text">Cuenta y Tarjeta<small>IBAN Espa√±ol y tarjeta virtual gratuita</small></div>
            </div>
            <div class="feat-card">
                <div class="feat-icon">üí∏</div>
                <div class="feat-text">Transferencias<small>Env√≠a dinero y Bizum al instante</small></div>
            </div>
            <div class="feat-card">
                <div class="feat-icon">üìä</div>
                <div class="feat-text">Control Total<small>Gr√°ficos de gastos y gesti√≥n de l√≠mites</small></div>
            </div>
            <div class="feat-card">
                <div class="feat-icon">üê∑</div>
                <div class="feat-text">Ahorro<small>Hucha digital y redondeo autom√°tico</small></div>
            </div>
        </div>
        <button class="welcome-btn" onclick="closeWelcomeModal()" style="background: var(--accent); color: white; margin-top: 20px;">Comenzar a Operar</button>
    </div>
</div>

<div id="profile-modal" class="modal-overlay">
    <div class="modal-content profile-full-modal">
        <span class="close-modal" onclick="closeProfile()" style="color:var(--text); right: 25px; top: 15px;">√ó</span>
        <header class="bank-header"><h2>SecureBank Ultimate</h2></header>
        <div class="profile-body">
            <h2 class="profile-section-title">Editar Perfil Personal</h2>
            <div class="profile-grid">
                <div class="p-group"><label class="p-label">Nombre</label><input type="text" id="edit-name"></div>
                <div class="p-group"><label class="p-label">Apellidos</label><input type="text" id="edit-last"></div>
                <div class="p-group"><label class="p-label">Email</label><input type="email" id="edit-email"></div>
                <div class="p-group"><label class="p-label">Tel√©fono</label><input type="tel" id="edit-phone"></div>
                <div class="p-group full"><label class="p-label">Direcci√≥n</label><input type="text" id="edit-address"></div>
                <div class="p-group"><label class="p-label">Ciudad</label><input type="text" id="edit-city"></div>
                <div class="p-group"><label class="p-label">Pa√≠s</label><input type="text" id="edit-country" value="Espa√±a" readonly></div>
                <div class="p-group full" style="margin-top: 15px; border-top: 1px solid var(--border); padding-top: 15px;"><h3 style="font-size: 1rem; margin: 0 0 10px 0; color: var(--accent);">Seguridad</h3></div>
                <div class="p-group"><label class="p-label">Nueva Contrase√±a</label><input type="password" id="edit-pass-new"></div>
                <div class="p-group"><label class="p-label">Confirmar Contrase√±a</label><input type="password" id="edit-pass-confirm"></div>
            </div>

            <div class="profile-actions">
                <button onclick="closeProfile()" class="btn btn-p-cancel">Cancelar</button>
                <button onclick="saveProfile()" class="btn btn-p-save">Guardar Cambios</button>
            </div>
        </div>
        <footer class="bank-footer">
            <div class="bank-footer-logo"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM11 19.93C7.05 19.44 4 16.08 4 12C4 11.38 4.08 10.79 4.21 10.21L9 15L11 17V19.93ZM17.9 17.39C17.64 16.8 16.9 16 16 16H15V13H17V11H13V9H15V7H13V5.18C16.97 5.93 20 9.41 20 13.5C20 14.93 19.2 16.29 17.9 17.39Z"/></svg> SecureBank</div>
            <div class="bank-footer-text">&copy; Banco SecureBank S.A.</div>
        </footer>
    </div>
</div>

<div id="premium-modal" class="modal-overlay">
    <div class="modal-content wide">
        <span class="close-modal" onclick="closePremiumModal()">√ó</span>

        <div class="premium-hero">
            <h3 class="premium-title">SecureBank PREMIUM üåü</h3>
            <p style="color:var(--text-muted); margin:0;">Desbloquea el m√°ximo potencial de tu dinero.</p>
        </div>

        <div class="premium-grid">
            <div class="feat-card">
                <div class="feat-icon">üí≥</div>
                <div class="feat-text">Tarjeta GOLD<small>Dise√±o exclusivo met√°lico</small></div>
            </div>
            <div class="feat-card">
                <div class="feat-icon">üöÄ</div>
                <div class="feat-text">0% Comisiones<small>En operaciones Crypto</small></div>
            </div>
            <div class="feat-card">
                <div class="feat-icon">üìà</div>
                <div class="feat-text">3.5% TAE<small>Rentabilidad diaria en hucha</small></div>
            </div>
            <div class="feat-card">
                <div class="feat-icon">üí∞</div>
                <div class="feat-text">Cashback 1%<small>Devoluci√≥n en compras</small></div>
            </div>
            <div class="feat-card">
                <div class="feat-icon">ü§ù</div>
                <div class="feat-text">Pr√©stamos 4%<small>Inter√©s preferente garantizado</small></div>
            </div>
            <div class="feat-card">
                <div class="feat-icon">üéß</div>
                <div class="feat-text">Soporte VIP<small>Atenci√≥n prioritaria 24/7</small></div>
            </div>
        </div>

        <div id="premium-actions">
            <div class="premium-price">9.99 ‚Ç¨ <span style="font-size:0.4em; color:var(--text-muted); font-weight:normal; vertical-align:middle;">/ mes</span></div>
            <button onclick="buyPremium()" class="btn-upgrade">HAZTE PREMIUM AHORA</button>
            <p style="font-size:0.8em; color:var(--text-muted); margin-top:10px;">Cancela cuando quieras. Sin permanencia.</p>
        </div>

        <div id="premium-owned" style="display:none; margin-top: 20px; padding: 20px; border: 1px solid var(--green); border-radius: 10px; background: rgba(34, 197, 94, 0.05);">
            <h3 style="color: var(--green); margin-top:0;">‚úÖ ¬°Eres miembro Premium!</h3>
            <p style="color: var(--text-muted);">Disfrutas de todas las ventajas exclusivas.</p>
            <p style="font-size: 0.9em; margin: 15px 0;"><b>Renovaci√≥n autom√°tica:</b> <span id="premium-expiry-date"></span></p>
            <button onclick="cancelPremium()" style="background: transparent; border: 1px solid var(--red); color: var(--red); width: auto; font-size: 0.9em; padding: 10px 20px; margin-top:10px;">Cancelar Suscripci√≥n</button>
        </div>
    </div>
</div>

<script>
    const API_URL = 'http://localhost:8081';
    let user = null; // Guardar√° el usuario completo, con .dni y .isPremium
    let selectedCoin = 'bitcoin';
    let currentPrice = null;
    let cryptoChart = null, expensesChart = null, monthlyChart = null;
    let updateInterval = null, fiatRates = null;
    const CRYPTO_FALLBACK = { 'bitcoin': 77000, 'ethereum': 2600, 'solana': 140 };
    const BINANCE_SYMBOLS = { 'bitcoin': 'BTCEUR', 'ethereum': 'ETHEUR', 'solana': 'SOLEUR' };
    const CHART_STEPS = { 'bitcoin': 500, 'ethereum': 50, 'solana': 5 };
    let allTransactionsCache = [];
    let currentIban = null, currentBalance = 0;
    let savings = 0; const savingsGoal = 1000;
    let isCardUnlocked = false;
    let isDarkMode = true;
    let isRoundUpActive = false;
    let myMessages = [];
    let inactivityTimer = null;

    /* =================== UTILS =================== */
    function showLoading(msg) {
        document.getElementById('loader-text').innerText = msg || "Cargando...";
        document.getElementById('loader-overlay').style.display = 'flex';
    }
    function hideLoading() {
        document.getElementById('loader-overlay').style.display = 'none';
    }
    function startInactivityTimer() {
        if(inactivityTimer) clearTimeout(inactivityTimer);
        window.onmousemove = window.onkeypress = resetTimer;
        resetTimer();
    }
    function resetTimer() {
        clearTimeout(inactivityTimer);
        if(user) inactivityTimer = setTimeout(autoLogout, 300000); // 5 min
    }
    function autoLogout() {
        alert("üîí Sesi√≥n cerrada por seguridad (inactividad).");
        logout();
    }

    // --- NUEVO: Funci√≥n para resetear datos locales corruptos ---
    function hardResetLocalData() {
        if(confirm("¬øEst√°s seguro? Esto borrar√° la cach√© local (Premium, Portfolio) pero NO borrar√° tu cuenta del servidor.")) {
            localStorage.clear();
            alert("üßπ Datos locales limpiados. Se recargar√° la p√°gina.");
            location.reload();
        }
    }

    function formatDateTime(isoString) {
        if(!isoString) return new Date().toISOString().slice(0, 19).replace('T', ' ');
        const d = new Date(isoString);
        if (isNaN(d.getTime())) return isoString;
        const pad = (n) => n.toString().padStart(2, '0');
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    // =========================================
    // L√ìGICA PERSISTENCIA H√çBRIDA (SOLUCI√ìN DEFINITIVA)
    // =========================================
    async function saveUserStatus(newStatus) {
        showLoading("Actualizando plan...");

        await new Promise(r => setTimeout(r, 500));

        user.isPremium = newStatus;
        const key = 'premium_status_' + user.dni.trim();
        localStorage.setItem(key, newStatus);

        // --- GUARDAR FECHA EXPIRACI√ìN ---
        if(newStatus) {
            const expiry = new Date();
            expiry.setDate(expiry.getDate() + 30);
            localStorage.setItem('premium_expiry_' + user.dni.trim(), expiry.toISOString());
        } else {
            localStorage.removeItem('premium_expiry_' + user.dni.trim());
        }

        updatePlanUI();
        hideLoading();
    }

    // =========================================
    // RESTO DE FUNCIONES
    // =========================================
    function initMessages() {
        const hoy = formatDateTime(new Date());
        let base = [{ id: 2, title: "üîí Aviso", date: hoy, body: "Inicio sesi√≥n detectado.", read: false }];
        myMessages = base;
    }
    function updateBadge() {
        const u = myMessages.filter(m => !m.read).length;
        const b = document.getElementById('notif-badge');
        if (u > 0) { b.style.display = 'flex'; b.innerText = u; } else { b.style.display = 'none'; }
    }
    function openMailbox() { document.getElementById('mailbox-modal').style.display = 'flex'; renderMessages(); }
    function closeMailbox() { document.getElementById('mailbox-modal').style.display = 'none'; }
    function renderMessages() {
        const l = document.getElementById('mailbox-list'); l.innerHTML = '';
        if(myMessages.length === 0) { l.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-muted)">No tienes notificaciones.</div>'; return; }
        myMessages.forEach(m => {
            const d = document.createElement('div'); d.className = `msg-item ${m.read?'':'unread'}`;
            d.onclick = () => { d.classList.toggle('expanded'); if(!m.read) { m.read = true; updateBadge(); d.classList.remove('unread'); } };
            d.innerHTML = `<span class="msg-title">${m.read?'':'üîµ '} ${m.title}</span><div class="msg-body">${m.body}</div><div style="font-size:0.7em; color:var(--text-muted); margin-top:5px; text-align:right;">${m.date}</div>`;
            l.appendChild(d);
        });
    }
    function markAllRead() { myMessages.forEach(m => m.read = true); updateBadge(); renderMessages(); }
    function toggleTheme() {
        isDarkMode = !isDarkMode; document.body.classList.toggle('light-mode');
        document.getElementById('theme-icon').innerText = isDarkMode ? 'üåô' : '‚òÄÔ∏è';
        if(monthlyChart) { monthlyChart.options.scales.x.ticks.color = isDarkMode ? '#94a3b8' : '#64748b'; monthlyChart.update(); }
        if(expensesChart) { expensesChart.options.plugins.legend.labels.color = isDarkMode ? 'white' : 'black'; expensesChart.update(); }
    }
    function updateLoanCalc() {
        const a = document.getElementById('loan-slider').value; document.getElementById('loan-amount-display').innerText = a + " ‚Ç¨";
        const rate = (user && user.isPremium) ? 0.04 : 0.08; document.getElementById('loan-interest').innerText = (rate * 100) + "%";
        document.getElementById('loan-monthly').innerText = ((a * (1 + (rate * 2))) / 24).toFixed(2) + " ‚Ç¨";
    }
    async function requestLoan() {
        const a = document.getElementById('loan-slider').value;
        if(confirm(`¬øSolicitar pr√©stamo de ${a}‚Ç¨?`)) {
            showLoading("Evaluando riesgo...");
            await new Promise(r => setTimeout(r, 2000));
            // Simulamos ingreso llamando a deposit
            await fetch(API_URL+'/api/deposit', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({iban:currentIban, amount:a}) });
            hideLoading();
            alert("‚úÖ Pr√©stamo concedido.");
            loadData(); // RECARGA TODO
            myMessages.unshift({ id: Date.now(), title: "üí∞ Pr√©stamo", date: formatDateTime(new Date()), body: `Ingresados ${a}‚Ç¨.`, read: false }); updateBadge();
        }
    }
    function updateCardLimit() { document.getElementById('limit-display').innerText = document.getElementById('limit-slider').value + " ‚Ç¨"; }

    // --- PERSISTENCIA DEL REDONDEO ---
    function toggleRoundUp() {
        isRoundUpActive = document.getElementById('roundup-toggle').checked;
        if (user && user.dni) {
            localStorage.setItem('roundup_active_' + user.dni.trim(), isRoundUpActive);
        }
        if(isRoundUpActive) alert("üîÑ Redondeo activado.");
    }

    function updatePlanUI() {
        if (!user) return;
        const p = user.isPremium;
        const headerBadge = document.getElementById('header-plan-badge');
        const header = document.getElementById('global-header');
        const footer = document.getElementById('global-footer');

        if (p) {
            headerBadge.innerText = 'PREMIUM üåü'; headerBadge.className = 'header-badge plan-premium';
            header.classList.add('premium-mode'); footer.classList.add('premium-mode');
            document.getElementById('virtual-card').classList.add('gold');
        } else {
            headerBadge.innerText = 'Hazte PREMIUM'; headerBadge.className = 'header-badge plan-free';
            header.classList.remove('premium-mode'); footer.classList.remove('premium-mode');
            document.getElementById('virtual-card').classList.remove('gold');
        }
        document.getElementById('premium-msg').style.display = p ? 'block' : 'none';
        document.getElementById('apy-badge').innerText = p ? 'üî• 3.5% TAE' : '0% TAE';
        p ? document.getElementById('apy-badge').classList.add('premium') : document.getElementById('apy-badge').classList.remove('premium');
        document.getElementById('cashback-card').style.display = p ? 'block' : 'none';
        updateLoanCalc();
    }

    function openPremiumModal() {
        document.getElementById('premium-modal').style.display = 'flex';

        // --- MOSTRAR FECHA EXPIRACI√ìN ---
        if(user && user.isPremium) {
            document.getElementById('premium-actions').style.display='none';
            document.getElementById('premium-owned').style.display='block';
            const expKey = 'premium_expiry_' + user.dni.trim();
            const expDateStr = localStorage.getItem(expKey);
            if(expDateStr) {
                const d = new Date(expDateStr);
                document.getElementById('premium-expiry-date').innerText = d.toLocaleDateString();
            } else {
                document.getElementById('premium-expiry-date').innerText = "Indefinida";
            }
        } else {
            document.getElementById('premium-actions').style.display='block';
            document.getElementById('premium-owned').style.display='none';
        }
    }
    function closePremiumModal() { document.getElementById('premium-modal').style.display = 'none'; }

    // --- MODAL BIENVENIDA (ONBOARDING) ---
    function checkFirstLogin() {
        // Ejecutamos con retardo para asegurar que el Dashboard se haya pintado
        setTimeout(() => {
            try {
                const welcomeKey = 'show_welcome_for_' + user.dni.trim();
                if (localStorage.getItem(welcomeKey) === 'true') {
                    const modal = document.getElementById('welcome-modal');
                    if(modal) modal.style.display = 'flex';
                }
            } catch(e) { console.error("Error welcome modal", e); }
        }, 500);
    }

    function closeWelcomeModal() {
        const welcomeKey = 'show_welcome_for_' + user.dni.trim();
        localStorage.removeItem(welcomeKey); // Borrar para que no vuelva a salir
        document.getElementById('welcome-modal').style.display = 'none';
    }

    // --- COBRO DE PREMIUM CON PROTECCI√ìN DOBLE PAGO ---
    async function buyPremium() {
        if (user.isPremium) {
            alert("‚ö†Ô∏è ¬°Ya eres Premium! No es necesario pagar de nuevo.");
            closePremiumModal();
            return;
        }

        const COST = 9.99;

        // 1. Validar saldo localmente primero
        if (currentBalance < COST) {
            alert(`‚ùå Saldo insuficiente. Necesitas ${COST}‚Ç¨ para la suscripci√≥n.`);
            return;
        }

        if(confirm(`¬øConfirmar suscripci√≥n Premium por ${COST} ‚Ç¨/mes?`)) {
            showLoading("Procesando pago y activando...");

            try {
                // 2. Intentar cobrar enviando un CONCEPTO DE SISTEMA √öNICO
                const paymentResponse = await fetch(API_URL + '/api/transfer', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        sourceIban: currentIban,
                        destIban: "ES0000000000000000000000", // Cuenta sistema ficticia
                        amount: COST,
                        concept: "CUOTA PREMIUM SECUREBANK"
                    })
                });

                if (!paymentResponse.ok) {
                    const errorTxt = await paymentResponse.text();
                    throw new Error(errorTxt || "Error en el cobro");
                }

                // 3. Si el cobro fue bien, actualizamos el estado
                await saveUserStatus(true);

                // 4. Recargar datos (IMPORTANTE: Esto actualizar√° el gr√°fico tambi√©n)
                await loadData();

                closePremiumModal();
                alert("¬°Bienvenido al club PREMIUM! üåü Se han descontado 9.99‚Ç¨.");
                myMessages.unshift({
                    id: Date.now(),
                    title: "üåü Welcome Premium",
                    date: formatDateTime(new Date()),
                    body: "Disfruta de todas las ventajas. Se ha realizado el cargo de la cuota mensual.",
                    read: false
                });
                updateBadge();

            } catch (error) {
                console.error(error);
                alert("‚ùå No se pudo completar la suscripci√≥n: " + error.message);
            } finally {
                hideLoading();
            }
        }
    }

    function cancelPremium() { if(confirm("¬øVolver al plan gratuito?")) { saveUserStatus(false); closePremiumModal(); alert("Has vuelto al plan gratuito."); } }

    function openProfile() {
        document.getElementById('edit-name').value = user.firstName; document.getElementById('edit-last').value = user.lastName;
        document.getElementById('edit-email').value = user.firstName.toLowerCase() + "." + user.lastName.toLowerCase().replace(/\s/g, '') + "@securebank.com";
        document.getElementById('edit-phone').value = "+34 600 123 456";
        document.getElementById('profile-modal').style.display = 'flex';
    }
    function closeProfile() { document.getElementById('profile-modal').style.display = 'none'; }
    function saveProfile() {
        const n = document.getElementById('edit-name').value; const l = document.getElementById('edit-last').value;
        user.firstName = n; user.lastName = l; document.getElementById('user-display').innerText = user.firstName;
        closeProfile(); alert("‚úÖ Perfil actualizado.");
    }

    function showAuthTab(t) {
        document.getElementById('login-form').style.display = t==='login'?'block':'none';
        document.getElementById('reg-form').style.display = t==='reg'?'block':'none';
        document.querySelectorAll('.auth-tab').forEach(e => e.classList.remove('active')); event.target.classList.add('active');
    }
    function showDashTab(t) {
        document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        const buttons = document.querySelectorAll('.nav-btn');
        const mapping = {'home':0, 'cards':1, 'hub':2, 'analytics':3};
        if(mapping[t] !== undefined) buttons[mapping[t]].classList.add('active');
        document.getElementById('tab-' + t).classList.add('active');
        if(t==='analytics' && currentIban) { updateMonthly(currentIban); updateExpenses(currentIban); }
        if(t==='hub') window.dispatchEvent(new Event('resize'));
    }

    function updateHuchaUI() {
        document.getElementById('savings-display').innerText = savings.toFixed(2) + ' ‚Ç¨';
        document.getElementById('progress-bar').style.width = Math.min((savings / savingsGoal) * 100, 100) + '%';
    }
    async function addToHucha(val) {
        const v = val || parseFloat(document.getElementById('hucha-input').value);
        if(v > 0) {
            showLoading("Guardando...");
            try {
                const r = await fetch(API_URL + '/api/savings/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ iban: currentIban, amount: v })
                });

                if(r.ok) {
                    savings += v;
                    if(!val) document.getElementById('hucha-input').value='';
                    updateHuchaUI();
                    loadData();
                    if(!val) alert(`‚úÖ Guardados ${v}‚Ç¨ en tu hucha.`);
                } else {
                    const msg = await r.text();
                    alert("‚ùå Error: " + msg);
                }
            } catch(e) { alert("Error de red"); }
            hideLoading();
        }
    }

    async function resetHucha() {
        if(savings <= 0) return alert("La hucha est√° vac√≠a.");
        if(confirm(`¬øRomper la hucha y recuperar ${savings.toFixed(2)}‚Ç¨?`)) {
            showLoading("Recuperando ahorros...");
            try {
                const r = await fetch(`${API_URL}/api/savings/break`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ iban: currentIban, amount: savings })
                });
                if(r.ok) {
                    savings = 0;
                    updateHuchaUI();
                    loadData();
                    alert("üî® Hucha rota. Dinero devuelto a tu cuenta.");
                }
            } catch(e) { alert("Error"); }
            hideLoading();
        }
    }

    // --- CORRECCI√ìN FINAL: LOGIN ROBUSTO CON TRIM ---
    async function login() {
        const dRaw = document.getElementById('l-dni').value;
        const d = dRaw ? dRaw.trim() : ""; // DNI limpio
        const p = document.getElementById('l-pass').value;

        showLoading("Iniciando sesi√≥n segura...");
        try {
            await new Promise(r => setTimeout(r, 1000));
            const r = await fetch(API_URL + '/api/login', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({dni:d, password:p}) // Enviamos el limpio
            });

            if(r.ok) {
                user = await r.json();

                // CORRECCI√ìN CR√çTICA: Si el backend no devuelve el DNI, usamos el del input
                if (!user.dni) user.dni = d;

                console.log("[DEBUG] Login Exitoso. DNI:", user.dni);

                // RECUPERAR ESTADO PREMIUM USANDO LA MISMA CLAVE (input DNI)
                const key = 'premium_status_' + d;
                const storedPremium = localStorage.getItem(key);

                console.log("[DEBUG] Leyendo clave premium:", key, "Valor:", storedPremium);

                if (storedPremium !== null) {
                    user.isPremium = (storedPremium === 'true');
                } else {
                    if(typeof user.isPremium === 'undefined') user.isPremium = false;
                }

                startDashboard();
                startInactivityTimer();
                checkFirstLogin(); // Verificar si mostrar bienvenida
            } else {
                alert("Datos incorrectos");
            }
        } catch(e) {
            console.error(e);
            alert("Error servidor o conexi√≥n.");
        }
        hideLoading();
    }

    // --- GENERACI√ìN IBAN & REGISTRO ---
    async function register() {
        // 1. Generar IBAN ES + 22 d√≠gitos
        let ibanNums = '';
        for (let i = 0; i < 22; i++) {
            ibanNums += Math.floor(Math.random() * 10);
        }
        const randomIban = 'ES' + ibanNums;

        const dRaw = document.getElementById('r-dni').value;
        const dniVal = dRaw ? dRaw.trim() : "";

        const d = {
            dni: dniVal,
            firstName: document.getElementById('r-name').value,
            lastName: document.getElementById('r-last').value,
            password: document.getElementById('r-pass').value,
            iban: randomIban
        };

        if(!d.dni || !d.password) { alert("Rellena los campos"); return; }
        showLoading("Creando cuenta...");

        try {
            const r = await fetch(API_URL + '/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(d)
            });

            hideLoading();

            if (r.ok) {
                // Inicializamos estado premium a false
                localStorage.setItem('premium_status_' + dniVal, 'false');

                // MARCAMOS ESTE USUARIO COMO RECI√âN REGISTRADO PARA MOSTRAR BIENVENIDA
                localStorage.setItem('show_welcome_for_' + dniVal, 'true');

                alert("Registro exitoso. Tu cuenta es: " + randomIban);
                window.location.reload();
            } else {
                const msg = await r.text();
                alert("No se pudo registrar: " + msg);
            }
        } catch(e) {
            hideLoading();
            console.error(e);
            alert("Error de conexi√≥n con el servidor.");
        }
    }

    function logout() { location.reload(); }

    function startDashboard() {
        document.getElementById('auth-view').style.display = 'none';
        document.getElementById('global-header').style.display = 'flex';
        document.getElementById('dashboard-view').style.display = 'block';
        document.getElementById('global-footer').style.display = 'block';
        document.getElementById('user-display').innerText = user.firstName;
        updatePlanUI(); initMessages(); loadData(); initCrypto(); fetchFiatRates(); updateHuchaUI(); calculate(); updateBadge(); updateLoanCalc();
    }

    async function loadData() {
        try {
            const r = await fetch(API_URL + `/api/accounts/${user.dni}`);
            const a = await r.json();
            const l = document.getElementById('acc-list'); const s = document.getElementById('t-source');
            l.innerHTML = ''; s.innerHTML = '';

            if (a.length === 0) {
                l.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted)">No tienes cuentas.</div>';
            } else {
                a.forEach(acc => {
                    l.innerHTML += `<div class="acc-item"><div><small>${acc.iban}</small><br><b>${acc.alias}</b></div><div style="text-align:right"><span style="color:var(--green); font-weight:bold;">${acc.balance.toFixed(2)} ‚Ç¨</span></div></div>`;
                    let o = document.createElement('option'); o.value = acc.iban; o.text = `${acc.alias} (${acc.balance.toFixed(2)} ‚Ç¨)`; s.add(o);
                });
                currentIban = a[0].iban;
                currentBalance = a[0].balance;
                setTimeout(() => fetchHistoryAndShowRestricted(currentIban, currentBalance), 10);
                if (a[0].frozen) {
                    document.querySelector('.card-scene').parentElement.classList.add('frozen');
                    document.getElementById('btn-freeze-card').classList.add('active-freeze');
                    document.getElementById('btn-freeze-text').innerText = "Descongelar";
                }
            }

            // --- CARGAR PORTFOLIO PERSISTENTE (LOCALSTORAGE) ---
            const key = 'portfolio_' + user.dni.trim();
            const storedPortfolio = JSON.parse(localStorage.getItem(key)) || { BTC: 0, ETH: 0, SOL: 0 };

            let portfolioHtml = '';
            const defaultCoins = ['BTC', 'ETH', 'SOL'];
            const icons = {
                'BTC': 'https://raw.githubusercontent.com/spothq/cryptocurrency-icons/master/32/icon/btc.png',
                'ETH': 'https://raw.githubusercontent.com/spothq/cryptocurrency-icons/master/32/icon/eth.png',
                'SOL': 'https://raw.githubusercontent.com/spothq/cryptocurrency-icons/master/32/icon/sol.png'
            };

            defaultCoins.forEach(symbol => {
                const amount = storedPortfolio[symbol] || 0.00000;
                portfolioHtml += `
                    <div style="display:flex;justify-content:space-between;padding:12px 8px;border-bottom:1px solid var(--border); align-items:center;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <img src="${icons[symbol]}" width="24" onerror="this.style.display='none'">
                            <b>${symbol}</b>
                        </div>
                        <span style="${amount > 0 ? 'color:var(--text)' : 'color:var(--text-muted)'}">${amount.toFixed(6)}</span>
                    </div>`;
            });

            document.getElementById('portfolio-list').innerHTML = portfolioHtml;

            // --- CARGAR PERSISTENCIA HUCHA Y REDONDEO ---
            // 1. Cargar estado de la hucha (remoto)
            loadSavingsPersistence();

            // 2. Cargar estado del toggle redondeo (local)
            const roundUpKey = 'roundup_active_' + user.dni.trim();
            const savedRoundUp = localStorage.getItem(roundUpKey);
            if (savedRoundUp !== null) {
                isRoundUpActive = (savedRoundUp === 'true');
                document.getElementById('roundup-toggle').checked = isRoundUpActive;
            }

            // --- ACTUALIZAR GR√ÅFICOS SI ESTAMOS EN ESA PESTA√ëA ---
            if(document.getElementById('tab-analytics').classList.contains('active')) {
                updateMonthly(currentIban);
                updateExpenses(currentIban);
            }

        } catch(e) { console.error("Error loading data", e); }
        updateCashbackUI();
    }

    async function loadSavingsPersistence() {
        if(!currentIban) return;
        try {
            const r = await fetch(`${API_URL}/api/savings/${currentIban}`);
            if(r.ok) {
                const data = await r.json();
                savings = data.amount || 0;
                // NOTA: Ignoramos roundUpActive del servidor porque usamos localStorage
                updateHuchaUI();
            }
        } catch(e) { console.log("Persistencia hucha no disponible"); }
    }

    const rates = { EUR: 1, USD: 1.08, GBP: 0.85, JPY: 158.50, BTC: 0 };
    function calculate() {
        const a1 = document.getElementById('amount-one').value; const c1 = document.getElementById('currency-one').value; const c2 = document.getElementById('currency-two').value;
        const rate = (c) => { if(c === 'BTC') return currentPrice ? 1/currentPrice : 0; if(fiatRates && fiatRates[c]) return 1/fiatRates[c]; return 1/rates[c]; };
        let v1 = c1 === 'EUR' ? a1 : (c1 === 'BTC' ? a1 * currentPrice : a1 / (fiatRates ? fiatRates[c1] : rates[c1]));
        let v2 = c2 === 'EUR' ? v1 : (c2 === 'BTC' ? v1 / currentPrice : v1 * (fiatRates ? fiatRates[c2] : rates[c2]));
        document.getElementById('amount-two').value = v2.toFixed(6);
    }
    function yearChanged() { if(currentIban) updateMonthly(currentIban); }

    async function updateMonthly(i) {
        const y = document.getElementById('yearSelector').value;
        try {
            const r = await fetch(API_URL + `/api/monthly-chart/${i}?year=${y}`); const data = await r.json(); const d = new Array(12).fill(0);
            Object.keys(data).forEach(k => { if(k.startsWith(y)) d[parseInt(k.split('-')[1])-1] = data[k]; });
            const ctx = document.getElementById('monthlyChart').getContext('2d'); if(monthlyChart) monthlyChart.destroy();
            monthlyChart = new Chart(ctx, { type: 'bar', data: { labels: ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"], datasets: [{ label: `Gastos ${y}`, data: d, backgroundColor: '#3b82f6', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: {display:false}, ticks: {color: isDarkMode?'#94a3b8':'#64748b'} }, y: { ticks: {color: isDarkMode?'#94a3b8':'#64748b'} } } } });
        } catch(e){}
    }

    // --- GASTOS CORREGIDOS: DETECCI√ìN POR TIPO DE TRANSACCI√ìN ---
    async function updateExpenses(i) {
        try {
            const r = await fetch(API_URL + `/api/history/${i}`);
            const txs = await r.json();

            let stats = {
                'Inversi√≥n Crypto': 0,
                'Cuota App': 0,
                'Transferencias': 0,
                'Bizum': 0,
                'Ocio': 0,
                'Otros': 0
            };

            txs.forEach(tx => {
                const isExpense = (tx.sourceIban === i && tx.destIban !== i) || (tx.amount < 0);

                if (isExpense) {
                    const amt = Math.abs(tx.amount);
                    const desc = (tx.concept || "").trim().toUpperCase();

                    if (desc.includes("CUOTA PREMIUM SECUREBANK")) {
                        stats['Cuota App'] += amt;
                    } else if (desc.includes("COMPRA BITCOIN") || desc.includes("COMPRA ETHEREUM") || desc.includes("COMPRA SOLANA")) {
                        stats['Inversi√≥n Crypto'] += amt;
                    } else if (desc.includes('BIZUM')) {
                        stats['Bizum'] += amt;
                    } else if (tx.destIban) {
                        stats['Transferencias'] += amt;
                    } else if (desc.includes('RESTAURANTE') || desc.includes('CINE')) {
                        stats['Ocio'] += amt;
                    } else {
                        stats['Otros'] += amt;
                    }
                }
            });

            let finalLabels = [];
            let finalData = [];
            let colors = [];
            const colorMap = {
                'Inversi√≥n Crypto': '#8b5cf6',
                'Cuota App': '#f59e0b',
                'Transferencias': '#3b82f6',
                'Bizum': '#ec4899',
                'Ocio': '#ef4444',
                'Otros': '#64748b'
            };

            for (const [key, value] of Object.entries(stats)) {
                if (value > 0) {
                    finalLabels.push(key);
                    finalData.push(value);
                    colors.push(colorMap[key] || '#cbd5e1');
                }
            }

            if(finalData.length === 0) {
                finalLabels = ["Sin gastos"]; finalData = [1]; colors = ['#334155'];
            }

            const ctx = document.getElementById('expensesChart').getContext('2d');
            if(expensesChart) expensesChart.destroy();

            expensesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: finalLabels,
                    datasets: [{
                        data: finalData,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position:'right',
                            labels:{color: isDarkMode ? 'white' : 'black'}
                        }
                    }
                }
            });
        } catch(e){ console.error("Error chart", e); }
    }

    async function fetchHistoryAndShowRestricted(i, b) {
        try {
            const r = await fetch(API_URL + `/api/history/${i}`); allTransactionsCache = await r.json(); renderTable(allTransactionsCache.slice(0,5), i, b); document.getElementById('security-btn').style.display = allTransactionsCache.length > 5 ? 'block' : 'none';
        } catch(e) { document.getElementById('history-body').innerHTML = '<tr><td colspan="3">Error cargando historial</td></tr>'; }
    }
    function renderTable(txs, i, b) {
        let html = ''; let run = b;
        txs.forEach(tx => {
            const exp = (tx.sourceIban === i && tx.destIban !== i);
            const cleanDate = formatDateTime(tx.date);
            html += `<tr><td><b>${tx.concept||'Varios'}</b><br><small>${cleanDate}</small></td><td style="text-align:right"><div class="${exp?'amount-neg':'amount-pos'}">${exp?'-':'+'} ${tx.amount.toFixed(2)} ‚Ç¨</div></td><td style="text-align:center">üìÑ</td></tr>`;
            run += (exp ? tx.amount : -tx.amount);
        });
        document.getElementById('history-body').innerHTML = html || '<tr><td colspan="3" style="text-align:center">Sin movimientos</td></tr>';
    }
    function openSecurityModal() { document.getElementById('security-modal').style.display='flex'; }
    function closeSecurityModal() { document.getElementById('security-modal').style.display='none'; }
    async function confirmUnlock() { const p = document.getElementById('sec-pass').value; if(p) { renderTable(allTransactionsCache, currentIban, currentBalance); closeSecurityModal(); document.getElementById('security-btn').style.display='none'; } }
    function handleCardClick() { if(!isCardUnlocked) requestCardUnlock(); else flipCard(); }
    function flipCard() { document.getElementById('virtual-card').classList.toggle('flipped'); }
    function requestCardUnlock() { document.getElementById('card-privacy-modal').style.display='flex'; }
    function closeCardModal() { document.getElementById('card-privacy-modal').style.display='none'; }
    async function confirmCardUnlock() { isCardUnlocked=true; closeCardModal(); document.getElementById('btn-show-card').classList.add('active-eye'); flipCard(); }
    async function toggleCardFreeze() {
        if(!currentIban) return;
        showLoading("Conectando con Visa...");
        try {
            const r = await fetch(`${API_URL}/api/accounts/${currentIban}/toggle-freeze`, { method: 'POST' });
            if (r.ok) {
                const data = await r.json();
                const scene = document.querySelector('.card-scene').parentElement;
                const btn = document.getElementById('btn-freeze-card');

                if (data.frozen) {
                    scene.classList.add('frozen');
                    btn.classList.add('active-freeze');
                    document.getElementById('btn-freeze-text').innerText = "Descongelar";
                } else {
                    scene.classList.remove('frozen');
                    btn.classList.remove('active-freeze');
                    document.getElementById('btn-freeze-text').innerText = "Congelar";
                }
            }
        } catch(e) { console.error(e); alert("Error de conexi√≥n"); }
        hideLoading();
    }
    function copyToClipboard(t,e) { e.stopPropagation(); navigator.clipboard.writeText(t).then(()=>alert("Copiado: " + t)); }

    async function transfer() {
        const s = document.getElementById('t-source').value;
        const d = document.getElementById('t-dest').value;
        const a = parseFloat(document.getElementById('t-amount').value);
        const c = document.getElementById('t-concept').value || "";

        if(!d || !a || a <= 0) return alert("Por favor, revise los datos.");

        showLoading("Verificando seguridad...");

        try {
            const response = await fetch(API_URL + '/api/transfer', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ sourceIban: s, destIban: d, amount: a, concept: c })
            });

            hideLoading();
            const message = await response.text();

            if (response.ok) {
                // --- NUEVO: A√ëADIR CASHBACK LOCAL ---
                if(user.isPremium) {
                    addLocalCashback(a);
                }

                alert("‚úÖ √âXITO: " + message);
                if(isRoundUpActive && a > 0) { const resto = Math.ceil(a) - a; if(resto > 0.009) addToHucha(resto); }
                loadData();
                myMessages.unshift({ id: Date.now(), title: "üí∏ Transferencia", date: formatDateTime(new Date()), body: `Enviados ${a}‚Ç¨ a ${d}`, read: false });
                updateBadge();
            } else {
                alert("‚ùå OPERACI√ìN DENEGADA:\n\n" + message);
            }
        } catch (error) {
            hideLoading();
            alert("Error de conexi√≥n.");
        }
    }

    async function fetchFiatRates() { try{let r=await fetch('https://open.er-api.com/v6/latest/EUR'); fiatRates=(await r.json()).rates;}catch(e){fiatRates=null;} }
    function setCoin(c) { selectedCoin=c; document.querySelectorAll('.coin-btn').forEach(b=>b.classList.remove('active')); document.getElementById('btn-'+c).classList.add('active'); if(cryptoChart) { cryptoChart.data.datasets[0].data = []; cryptoChart.options.scales.y.ticks.stepSize = CHART_STEPS[c]; cryptoChart.update('none'); } fetchPrice(); }
    async function fetchPrice() {
        const symbol = BINANCE_SYMBOLS[selectedCoin];
        try { const r = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${symbol}`); if(r.ok) { const data = await r.json(); currentPrice = parseFloat(data.price); } else throw new Error(); } catch(e) { let b = CRYPTO_FALLBACK[selectedCoin]; currentPrice = b + (Math.random()-0.5)*(b*0.002); }
        document.getElementById('live-price').innerText=currentPrice.toLocaleString('es-ES', {style:'currency', currency:'EUR'});
        if(cryptoChart) { cryptoChart.data.datasets[0].data.push(currentPrice); if(cryptoChart.data.datasets[0].data.length>20) cryptoChart.data.datasets[0].data.shift(); cryptoChart.update('none'); } calculate();
    }
    function initCrypto() {
        const ctx=document.getElementById('cryptoChart').getContext('2d'); cryptoChart=new Chart(ctx,{ type:'line', data:{ labels:new Array(20).fill(''), datasets:[{data:new Array(20).fill(null),borderColor:'#22c55e',tension:0.4,pointRadius:0}] }, options:{ scales:{x:{display:false},y:{display:true}}, plugins:{legend:{display:false}}, animation:false } });
        setCoin('bitcoin'); setInterval(fetchPrice,3000);
    }

    // --- L√ìGICA DE TRADING CON PERSISTENCIA LOCAL BLINDADA ---
    async function trade(t) {
        if(!user.isPremium) alert("Comisi√≥n 1.5%"); else alert("0% Comisi√≥n (Premium)");

        const amountEur = parseFloat(document.getElementById('trade-eur').value);
        if(!amountEur || amountEur <= 0) return alert("Introduce cantidad");

        // SI NO HAY PRECIO, USAR FALLBACK
        let priceToUse = currentPrice;
        if (!priceToUse) {
            priceToUse = CRYPTO_FALLBACK[selectedCoin];
        }

        showLoading("Procesando operaci√≥n...");
        await new Promise(r => setTimeout(r, 2000));

        // Simular operaci√≥n en Backend
        await fetch(API_URL+'/api/crypto/trade', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                userId:user.dni,
                iban:document.getElementById('t-source').value,
                symbol:selectedCoin,
                type:t,
                amountEur:amountEur,
                currentPrice:priceToUse
            })
        });

        // --- GUARDAR EN LOCALSTORAGE ---
        const key = 'portfolio_' + user.dni.trim();
        let port = JSON.parse(localStorage.getItem(key)) || { BTC: 0, ETH: 0, SOL: 0 };
        const symbolMap = { 'bitcoin': 'BTC', 'ethereum': 'ETH', 'solana': 'SOL' };
        const sym = symbolMap[selectedCoin];

        // Calcular cantidad de crypto
        const cryptoAmount = amountEur / priceToUse;

        if (t === 'BUY') {
            port[sym] = (port[sym] || 0) + cryptoAmount;

            // --- NUEVO: A√ëADIR CASHBACK LOCAL EN COMPRA CRIPTO ---
            if(user.isPremium) {
                addLocalCashback(amountEur);
            }

        } else {
            if (port[sym] >= cryptoAmount) port[sym] -= cryptoAmount;
            else port[sym] = 0; // Venta simple, si no tiene suficiente, a 0
        }

        console.log("[DEBUG] Guardando crypto:", key, port);
        localStorage.setItem(key, JSON.stringify(port));

        loadData(); // Recargar para ver portfolio actualizado
        hideLoading();
    }

    function openBizumModal() { document.getElementById('bizum-modal').style.display='flex'; }
    function closeBizumModal() { document.getElementById('bizum-modal').style.display='none'; }

    // --- NUEVO: FUNCI√ìN REAL DE BIZUM ---
    async function sendBizum() {
        const phone = document.getElementById('bz-phone').value;
        const amount = parseFloat(document.getElementById('bz-amount').value);
        const conceptInput = document.getElementById('bz-concept').value;
        const concept = conceptInput ? `Bizum: ${conceptInput}` : `Bizum a ${phone}`;

        if(!phone || !amount || amount <= 0) return alert("Revisa los datos del Bizum.");

        showLoading("Enviando Bizum...");

        try {
            // Reutilizamos el endpoint de transferencia
            // Usamos currentIban como origen
            // Generamos un IBAN ficticio pero v√°lido en formato para el backend
            // El backend probablemente valida que empiece por ES y tenga 24 caracteres.
            // ES + 99 (control) + 20 d√≠gitos (rellenamos con 0)
            const destIban = "ES9900000000000000000000";

            const response = await fetch(API_URL + '/api/transfer', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    sourceIban: currentIban,
                    destIban: destIban, // Usamos la cuenta sistema v√°lida
                    amount: amount,
                    concept: concept
                })
            });

            if (response.ok) {
                // --- NUEVO: A√ëADIR CASHBACK LOCAL ---
                if(user.isPremium) {
                    addLocalCashback(amount);
                }

                if(isRoundUpActive && amount > 0) {
                    const resto = Math.ceil(amount) - amount;
                    if(resto > 0.009) addToHucha(resto);
                }

                alert("‚úÖ Bizum enviado con √©xito üì≤");
                closeBizumModal();

                await loadData(); // Recargar para actualizar saldo y gr√°fica

                myMessages.unshift({
                    id: Date.now(),
                    title: "‚ö° Bizum Enviado",
                    date: formatDateTime(new Date()),
                    body: `Has enviado ${amount}‚Ç¨ a ${phone}.`,
                    read: false
                });
                updateBadge();
            } else {
                const msg = await response.text();
                alert("‚ùå Error al enviar Bizum: " + msg);
            }
        } catch(e) {
            console.error(e);
            alert("Error de conexi√≥n.");
        } finally {
            hideLoading();
        }
    }

    // --- NUEVO: GESTI√ìN DE CASHBACK LOCAL ---
    function addLocalCashback(amount) {
        if(!user || !user.dni) return;
        const key = 'cashback_' + user.dni.trim();
        let current = parseFloat(localStorage.getItem(key)) || 0;

        // 1% del importe gastado
        const reward = amount * 0.01;
        current += reward;

        localStorage.setItem(key, current);
        updateCashbackUI();
    }

    function updateCashbackUI() {
        if (!user || !user.isPremium) return;
        const key = 'cashback_' + user.dni.trim();
        const val = parseFloat(localStorage.getItem(key)) || 0;
        const display = document.getElementById('cashback-display');
        if(display) display.innerText = val.toFixed(2) + " ‚Ç¨";
    }

    async function redeemCashback() {
        const key = 'cashback_' + user.dni.trim();
        const val = parseFloat(localStorage.getItem(key)) || 0;

        if(val <= 0.01) return alert("A√∫n no tienes suficiente cashback.");

        if(confirm(`¬øCanjear ${val.toFixed(2)}‚Ç¨ a tu cuenta?`)) {
            showLoading("Canjeando...");
            try {
                // Hacemos un ingreso real del dinero en la cuenta
                const r = await fetch(API_URL + '/api/deposit', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ iban: currentIban, amount: val })
                });

                if (r.ok) {
                    // Si el ingreso funcion√≥, reseteamos el contador local
                    localStorage.setItem(key, 0);
                    alert("‚úÖ ¬°Cashback canjeado! Revisa tu saldo.");
                    loadData();
                    updateCashbackUI();
                } else { alert("Error al canjear"); }
            } catch(e) { alert("Error de red"); }
            hideLoading();
        }
    }

    function openDepositModal() { document.getElementById('deposit-modal').style.display = 'flex'; }
    function closeDepositModal() { document.getElementById('deposit-modal').style.display = 'none'; }
    async function confirmDeposit() {
        const amount = document.getElementById('dep-amount').value;
        const source = document.getElementById('dep-source').value;
        if (!amount || amount <= 0) return alert("Cantidad inv√°lida");

        showLoading("Verificando ingreso...");
        await new Promise(r => setTimeout(r, 1500));
        await fetch(API_URL+'/api/deposit', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({iban:currentIban, amount:amount})
        });

        closeDepositModal();
        hideLoading();
        alert(`‚úÖ Ingreso de ${amount}‚Ç¨ realizado correctamente.`);
        loadData();
        myMessages.unshift({ id: Date.now(), title: "üì• Ingreso Recibido", date: formatDateTime(new Date()), body: `Recibidos ${amount}‚Ç¨ de ${source}.`, read: false });
        updateBadge();
    }
</script>
</body>
</html>